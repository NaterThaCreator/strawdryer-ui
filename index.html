<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Straw Dryer Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050712;
      --accent: #46e0ff;
      --accent-soft: rgba(70, 224, 255, 0.2);
      --accent-strong: rgba(70, 224, 255, 0.9);
      --danger: #ff4f7b;
      --text-main: #f5f7ff;
      --text-soft: #a5b0d0;
      --card-bg: rgba(15, 20, 45, 0.92);
      --card-border: rgba(255, 255, 255, 0.08);
      --radius-xl: 26px;
      --radius-lg: 18px;
      --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.75);
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.25s ease-out;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        Roboto, sans-serif;
      background: radial-gradient(circle at 0% 0%, #191d3a 0, #050712 45%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .grid-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.75;
      mix-blend-mode: soft-light;
      background-image: 
        linear-gradient(
          rgba(255, 255, 255, 0.03) 1px,
          transparent 1px
        ),
        linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.03) 1px,
          transparent 1px
        );
      background-size: 40px 40px;
      z-index: 0;
    }

    .orb {
      position: fixed;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      opacity: 0.35;
      filter: blur(60px);
      pointer-events: none;
      z-index: 0;
    }

    .orb.orb-cyan {
      background: #00f5ff;
      top: -80px;
      right: -40px;
    }

    .orb.orb-purple {
      background: #8b5cff;
      bottom: -100px;
      left: -60px;
    }

    .app-shell {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 460px;
      padding: 20px 16px 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      border-radius: var(--radius-xl);
      background: linear-gradient(
          140deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.01)
        ),
        var(--card-bg);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      backdrop-filter: blur(26px) saturate(145%);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-pill {
      font-size: 10px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--accent-strong);
      background: linear-gradient(90deg, rgba(70, 224, 255, 0.12), transparent);
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(70, 224, 255, 0.35);
    }

    h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .status-chip {
      border-radius: 999px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(
        circle at 0 0,
        rgba(86, 232, 155, 0.2),
        rgba(20, 31, 45, 0.95)
      );
      border: 1px solid rgba(132, 255, 195, 0.45);
      font-size: 11px;
      color: #b9ffd8;
      box-shadow: 0 0 16px rgba(109, 255, 189, 0.32);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #7dffc4;
      box-shadow: 0 0 10px rgba(125, 255, 196, 0.75);
    }

    .status-chip[data-state="off"] {
      background: radial-gradient(
        circle at 0 0,
        rgba(255, 115, 115, 0.18),
        rgba(20, 24, 35, 0.98)
      );
      border-color: rgba(255, 115, 140, 0.5);
      color: #ffd0d7;
      box-shadow: 0 0 16px rgba(255, 116, 150, 0.25);
    }

    .status-chip[data-state="off"] .status-dot {
      background: #ff6f7f;
      box-shadow: 0 0 10px rgba(255, 124, 142, 0.75);
    }

    .status-text-main {
      font-weight: 500;
    }

    .status-text-sub {
      opacity: 0.8;
      font-size: 10px;
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.15fr);
      gap: 14px;
    }

    @media (max-width: 420px) {
      .main-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .fan-shell {
      position: relative;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at 20% 0, #18203f 0, #050712 75%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 14px 10px 12px;
      overflow: hidden;
    }

    .fan-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at 50% 0,
        rgba(70, 224, 255, 0.12),
        transparent 58%
      );
      opacity: 0.9;
      pointer-events: none;
    }

    .fan-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .fan-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }

    .fan-speed-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(12, 208, 255, 0.14);
      border: 1px solid rgba(76, 231, 255, 0.65);
      color: #bff4ff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .fan-speed-value {
      font-weight: 600;
      font-size: 11px;
    }

    .fan-gauge-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 4px 0 0;
    }

    .fan-gauge {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fan-ring {
      position: absolute;
      inset: 4px;
      border-radius: 50%;
      background: conic-gradient(
        from -90deg,
        rgba(70, 224, 255, 0.02),
        rgba(70, 224, 255, 0.9),
        rgba(70, 224, 255, 0.04)
      );
      mask: radial-gradient(circle, transparent 60%, black 61%);
      opacity: 0.8;
      filter: blur(1px);
    }

    .fan-core {
      position: relative;
      width: 72px;
      height: 72px;
      border-radius: 24px;
      background: radial-gradient(circle at 30% 0, #263768, #050712);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow:
        0 0 0 1px rgba(39, 175, 219, 0.5),
        0 18px 35px rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }

    .fan-core::before {
      content: "";
      position: absolute;
      inset: -30%;
      background-image: radial-gradient(
          circle at 30% 0,
          rgba(255, 255, 255, 0.12),
          transparent 60%
        ),
        radial-gradient(
          circle at 80% 10%,
          rgba(111, 233, 255, 0.45),
          transparent 55%
        );
      opacity: 0.9;
      mix-blend-mode: screen;
    }

    .blade {
      position: absolute;
      inset: 10%;
      border-radius: 40px;
      border: 1px solid rgba(163, 248, 255, 0.35);
      background: radial-gradient(
        circle at 30% 0,
        rgba(163, 248, 255, 0.9),
        rgba(3, 34, 54, 1)
      );
      opacity: 0.92;
    }

    .blade:nth-child(1) {
      transform-origin: 50% 90%;
      clip-path: polygon(50% 0, 100% 100%, 0 100%);
    }

    .blade:nth-child(2) {
      transform-origin: 50% 10%;
      clip-path: polygon(0 0, 100% 0, 50% 100%);
    }

    .blade:nth-child(3) {
      transform-origin: 10% 50%;
      clip-path: polygon(0 50%, 100% 0, 100% 100%);
    }

    .blade:nth-child(4) {
      transform-origin: 90% 50%;
      clip-path: polygon(0 0, 100% 50%, 0 100%);
    }

    .fan-core[data-speed="0"] .blade {
      animation: none;
      opacity: 0.7;
      filter: grayscale(0.3);
    }

    .fan-core[data-speed="1"] .blade {
      animation: spin 1.4s linear infinite;
    }

    .fan-core[data-speed="2"] .blade {
      animation: spin 0.9s linear infinite;
    }

    .fan-core[data-speed="3"] .blade {
      animation: spin 0.55s linear infinite;
    }

    .fan-core::after {
      content: "";
      position: absolute;
      inset: 26%;
      border-radius: 50%;
      background: radial-gradient(circle, #0f1825, #02040a);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow:
        0 0 20px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(70, 224, 255, 0.6);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .fan-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill-label {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .pill-label span {
      color: var(--accent-strong);
      font-weight: 500;
    }

    .detail-right {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .block {
      border-radius: var(--radius-lg);
      background: radial-gradient(
        circle at 0 0,
        rgba(70, 224, 255, 0.12),
        rgba(7, 10, 25, 0.96)
      );
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 11px 11px;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .block-title {
      font-size: 12px;
      font-weight: 500;
    }

    .block-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(
        90deg,
        rgba(70, 224, 255, 0.8),
        rgba(111, 92, 255, 0.8)
      );
      outline: none;
      opacity: 0.95;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #f5f7ff;
      border: 2px solid rgba(70, 224, 255, 0.95);
      box-shadow:
        0 0 0 4px rgba(70, 224, 255, 0.35),
        0 8px 16px rgba(0, 0, 0, 0.7);
      cursor: pointer;
      margin-top: -6px;
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #f5f7ff;
      border: 2px solid rgba(70, 224, 255, 0.95);
      box-shadow:
        0 0 0 4px rgba(70, 224, 255, 0.35),
        0 8px 16px rgba(0, 0, 0, 0.7);
      cursor: pointer;
    }

    .speed-badge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 52px;
      text-align: center;
    }

    .speed-badge span {
      color: var(--accent-strong);
      font-weight: 500;
    }

    .timer-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .timer-input-group {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
    }

    .timer-input {
      width: 60px;
      padding: 5px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(4, 7, 18, 0.9);
      color: var(--text-main);
      font-size: 13px;
      text-align: center;
      outline: none;
    }

    .timer-input:focus {
      border-color: rgba(70, 224, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(70, 224, 255, 0.4);
    }

    .timer-unit {
      font-size: 11px;
      color: var(--text-soft);
    }

    .timer-chip {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(255, 255, 255, 0.18);
      color: var(--text-soft);
    }

    .timer-chip span {
      color: var(--accent-strong);
    }

    .actions-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 9px 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast),
        opacity var(--transition-fast);
      outline: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(
        circle at 0 0,
        rgba(111, 92, 255, 0.52),
        rgba(70, 224, 255, 0.95)
      );
      color: #050712;
      box-shadow:
        0 0 25px rgba(111, 92, 255, 0.72),
        0 14px 30px rgba(0, 0, 0, 0.85);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 35px rgba(111, 92, 255, 0.9),
        0 16px 34px rgba(0, 0, 0, 0.9);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow:
        0 0 20px rgba(111, 92, 255, 0.7),
        0 10px 22px rgba(0, 0, 0, 0.9);
    }

    .btn-ghost {
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.75);
    }

    .btn-ghost:hover {
      background: rgba(0, 0, 0, 0.7);
      transform: translateY(-1px);
    }

    .btn-ghost:active {
      transform: translateY(0);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.85);
    }

    .btn-danger {
      background: radial-gradient(
        circle at 0 0,
        rgba(255, 165, 165, 0.3),
        var(--danger)
      );
      color: #fff8fb;
      box-shadow:
        0 0 22px rgba(255, 79, 123, 0.7),
        0 14px 28px rgba(0, 0, 0, 0.85);
    }

    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 30px rgba(255, 79, 123, 0.9),
        0 16px 32px rgba(0, 0, 0, 0.9);
    }

    .btn-danger:active {
      transform: translateY(0);
      box-shadow:
        0 0 18px rgba(255, 79, 123, 0.7),
        0 10px 20px rgba(0, 0, 0, 0.9);
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 8px;
    }

    .meta-text {
      font-size: 10px;
      color: var(--text-soft);
    }

    .meta-highlight {
      color: var(--accent-strong);
    }

    .pill-small {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 10px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(0, 0, 0, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(70, 224, 255, 0.8);
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(80px);
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(6, 10, 24, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.85);
      font-size: 12px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-med),
        transform var(--transition-med);
      z-index: 20;
    }

    .toast[data-visible="true"] {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }

    .toast[data-variant="error"] {
      border-color: rgba(255, 115, 140, 0.9);
      color: #ffd0d7;
    }

    .toast-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-strong);
    }

    .toast[data-variant="error"] .toast-dot {
      background: var(--danger);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(
        circle at 20% 0,
        rgba(70, 224, 255, 0.2),
        rgba(5, 7, 18, 0.98)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      backdrop-filter: blur(16px);
    }

    .overlay-card {
      max-width: 360px;
      width: calc(100% - 48px);
      border-radius: 22px;
      background: linear-gradient(
          130deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.01)
        ),
        #050712;
      padding: 22px 18px 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.9);
    }

    .overlay-title {
      font-size: 18px;
      margin: 0 0 6px;
    }

    .overlay-sub {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .overlay-input-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .overlay-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(4, 7, 18, 0.95);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
    }

    .overlay-input:focus {
      border-color: rgba(70, 224, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(70, 224, 255, 0.5);
    }

    .overlay-btn-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .overlay-btn {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: radial-gradient(
        circle at 0 0,
        rgba(111, 92, 255, 0.4),
        rgba(70, 224, 255, 0.98)
      );
      color: #050712;
      box-shadow:
        0 0 18px rgba(111, 92, 255, 0.8),
        0 10px 26px rgba(0, 0, 0, 0.9);
    }

    .overlay-error {
      font-size: 11px;
      color: #ff98aa;
      margin-top: 6px;
      min-height: 14px;
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <div class="orb orb-cyan"></div>
  <div class="orb orb-purple"></div>

  <div class="app-shell">
    <div class="card">
      <div class="card-header">
        <div class="title-block">
          <div class="title-row">
            <div class="title-pill">Straw Dryer v1 · Cloud Linked</div>
          </div>
          <h1>Dryer Command Console</h1>
          <div class="subtitle">Control your fan remotely with live feedback.</div>
        </div>
        <div class="status-chip" id="statusChip" data-state="off">
          <div class="status-dot"></div>
          <div>
            <div class="status-text-main" id="statusTextMain">Standby</div>
            <div class="status-text-sub" id="statusTextSub">No command in queue</div>
          </div>
        </div>
      </div>

      <div class="main-layout">
        <div class="fan-shell">
          <div class="fan-header">
            <div class="fan-label">Fan visual</div>
            <div class="fan-speed-pill">
              <span class="fan-speed-value" id="fanSpeedLabel">0%</span>
              · speed
            </div>
          </div>

          <div class="fan-gauge-wrap">
            <div class="fan-gauge">
              <div class="fan-ring"></div>
              <div class="fan-core" id="fanCore" data-speed="0">
                <div class="blade"></div>
                <div class="blade"></div>
                <div class="blade"></div>
                <div class="blade"></div>
              </div>
            </div>
          </div>

          <div class="fan-footer">
            <div class="pill-label">
              Mode · <span id="modeLabel">Idle</span>
            </div>
            <div class="pill-label">
              Queue · <span id="queueLabel">None</span>
            </div>
          </div>
        </div>

        <div class="detail-right">
          <div class="block">
            <div class="block-header">
              <div class="block-title">Speed</div>
              <div class="block-sub">Adjust fan intensity.</div>
            </div>
            <div class="slider-row">
              <input
                type="range"
                id="speedSlider"
                min="0"
                max="100"
                value="60"
              />
              <div class="speed-badge">
                <span id="speedPercentLabel">60</span>%
              </div>
            </div>
            <div class="timer-row">
              <div class="timer-input-group">
                <input
                  class="timer-input"
                  id="minutesInput"
                  type="number"
                  min="0"
                  max="240"
                  value="15"
                />
                <div class="timer-unit">min</div>
                <input
                  class="timer-input"
                  id="secondsInput"
                  type="number"
                  min="0"
                  max="59"
                  value="0"
                />
                <div class="timer-unit">sec</div>
              </div>
              <div class="timer-chip">
                Countdown: <span id="timerSummary">15:00</span>
              </div>
            </div>
            <div class="actions-row">
              <button class="btn btn-primary" id="btnStart">
                Start &amp; Queue
              </button>
              <button class="btn btn-ghost" id="btnBoost">
                Quick Boost
              </button>
            </div>
          </div>

          <div class="block" style="background: radial-gradient(circle at 0 0, rgba(255, 121, 121, 0.18), rgba(6, 10, 24, 0.97));">
            <div class="block-header">
              <div class="block-title">Session</div>
              <div class="block-sub">Stop or clear commands.</div>
            </div>
            <div class="actions-row">
              <button class="btn btn-danger" id="btnStop">Stop Fan</button>
              <button class="btn btn-ghost" id="btnClear">
                Clear Queue
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="footer-row">
        <div class="meta-text">
          Backend: <span class="meta-highlight">Cloudflare Worker</span> ·
          Auth: <span class="meta-highlight">PIN-gated (“straw”)</span>
        </div>
        <div class="pill-small">
          <div class="pill-dot"></div>
          <span id="lastStatus">Idle</span>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="loginOverlay">
    <div class="overlay-card">
      <h2 class="overlay-title">Enter control PIN</h2>
      <div class="overlay-sub">
        This protects your dryer commands. Only devices with the correct PIN can
        send instructions.
      </div>
      <div class="overlay-input-label">PIN</div>
      <input
        id="passwordInput"
        class="overlay-input"
        type="password"
        autocomplete="off"
        placeholder="Enter PIN"
      />
      <div class="overlay-error" id="loginError"></div>
      <div class="overlay-btn-row">
        <button class="overlay-btn" id="loginBtn">Unlock console</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" data-visible="false" data-variant="neutral">
    <div class="toast-dot"></div>
    <div id="toastText">Status</div>
  </div>

  <script>
    const BACKEND = "https://rapid-star-f817.fieldsnathanj.workers.dev";
    const loginOverlay = document.getElementById("loginOverlay");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const loginError = document.getElementById("loginError");
    const speedSlider = document.getElementById("speedSlider");
    const speedPercentLabel = document.getElementById("speedPercentLabel");
    const minutesInput = document.getElementById("minutesInput");
    const secondsInput = document.getElementById("secondsInput");
    const timerSummary = document.getElementById("timerSummary");
    const statusChip = document.getElementById("statusChip");
    const statusTextMain = document.getElementById("statusTextMain");
    const statusTextSub = document.getElementById("statusTextSub");
    const fanCore = document.getElementById("fanCore");
    const fanSpeedLabel = document.getElementById("fanSpeedLabel");
    const modeLabel = document.getElementById("modeLabel");
    const queueLabel = document.getElementById("queueLabel");
    const lastStatus = document.getElementById("lastStatus");
    const toast = document.getElementById("toast");
    const toastText = document.getElementById("toastText");

    const btnStart = document.getElementById("btnStart");
    const btnBoost = document.getElementById("btnBoost");
    const btnStop = document.getElementById("btnStop");
    const btnClear = document.getElementById("btnClear");

    let uiPassword = "";
    let toastTimeout = null;

    function showToast(message, variant = "neutral") {
      toastText.textContent = message;
      toast.setAttribute("data-variant", variant);
      toast.setAttribute("data-visible", "true");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast.setAttribute("data-visible", "false");
      }, 2800);
    }

    function updateTimerSummary() {
      let m = parseInt(minutesInput.value || "0", 10);
      let s = parseInt(secondsInput.value || "0", 10);
      if (m < 0) m = 0;
      if (s < 0) s = 0;
      if (s > 59) s = 59;
      minutesInput.value = m;
      secondsInput.value = s;
      const mm = String(m).padStart(2, "0");
      const ss = String(s).padStart(2, "0");
      timerSummary.textContent = mm + ":" + ss;
      return m * 60 + s;
    }

    updateTimerSummary();

    speedSlider.addEventListener("input", () => {
      const val = parseInt(speedSlider.value, 10);
      speedPercentLabel.textContent = val;
      fanSpeedLabel.textContent = val + "%";
      let tier = 0;
      if (val >= 70) tier = 3;
      else if (val >= 40) tier = 2;
      else if (val > 0) tier = 1;
      fanCore.setAttribute("data-speed", tier.toString());
    });

    minutesInput.addEventListener("input", updateTimerSummary);
    secondsInput.addEventListener("input", updateTimerSummary);

    function setStatus(on, mainText, subText, mode, queue) {
      statusChip.setAttribute("data-state", on ? "on" : "off");
      statusTextMain.textContent = mainText;
      statusTextSub.textContent = subText;
      if (mode) modeLabel.textContent = mode;
      if (queue !== undefined) queueLabel.textContent = queue;
      lastStatus.textContent = mainText;
    }

    function getPayload(action, overrideSpeed = null, overrideTime = null) {
      const speedPercent =
        overrideSpeed !== null ? overrideSpeed : parseInt(speedSlider.value, 10);
      const totalSeconds =
        overrideTime !== null ? overrideTime : updateTimerSummary();
      let pwm = Math.round((speedPercent / 100) * 255);
      if (pwm < 0) pwm = 0;
      if (pwm > 255) pwm = 255;
      return {
        password: uiPassword,
        action,
        speed: pwm,
        time: totalSeconds,
      };
    }

    async function sendCommand(action, opts = {}) {
      if (!uiPassword) {
        showToast("Unlock with PIN first.", "error");
        return;
      }

      const payload = getPayload(
        action,
        opts.overrideSpeed ?? null,
        opts.overrideTime ?? null
      );

      try {
        setSendingState(true);

        const res = await fetch(BACKEND + "/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (res.status === 401) {
          showToast("PIN rejected by backend.", "error");
          setStatus(false, "Auth error", "Check PIN and reload.", "Error", "None");
          return;
        }

        if (!res.ok) {
          showToast("Backend error: " + res.status, "error");
          setStatus(false, "Send failed", "Check connection.", "Error", "None");
          return;
        }

        if (action === "START") {
          const seconds = payload.time;
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          const label = `${m}m ${s}s`;
          setStatus(
            true,
            "Running",
            `Queued for ${label} @ ${Math.round(
              (payload.speed / 255) * 100
            )}%`,
            "Active",
            "1 command"
          );
          showToast("Start command sent.", "neutral");
        } else if (action === "BOOST") {
          setStatus(
            true,
            "Boost",
            "Short high-speed burst queued.",
            "Boost",
            "1 command"
          );
          showToast("Boost command sent.", "neutral");
        } else if (action === "STOP") {
          setStatus(false, "Stopped", "Stop command queued.", "Idle", "Stop");
          showToast("Stop command sent.", "neutral");
        } else if (action === "CLEAR") {
          setStatus(false, "Cleared", "Queue cleared.", "Idle", "None");
          showToast("Queue cleared.", "neutral");
        }

      } catch (err) {
        console.error(err);
        showToast("Network error sending command.", "error");
        setStatus(false, "Offline?", "Cannot reach backend.", "Error", "None");
      } finally {
        setSendingState(false);
      }
    }

    function setSendingState(isSending) {
      [btnStart, btnBoost, btnStop, btnClear].forEach((btn) => {
        btn.disabled = isSending;
        btn.style.opacity = isSending ? "0.7" : "1";
      });
    }

    btnStart.addEventListener("click", () => {
      sendCommand("START");
    });

    btnBoost.addEventListener("click", () => {
      sendCommand("START", { overrideSpeed: 100, overrideTime: 60 });
    });

    btnStop.addEventListener("click", () => {
      sendCommand("STOP", { overrideTime: 0 });
    });

    btnClear.addEventListener("click", () => {
      sendCommand("CLEAR", { overrideTime: 0, overrideSpeed: 0 });
    });

    loginBtn.addEventListener("click", () => {
      const val = passwordInput.value.trim();
      if (!val) {
        loginError.textContent = "PIN required.";
        return;
      }
      if (val !== "straw") {
        loginError.textContent = "Incorrect PIN.";
        showToast("Wrong PIN.", "error");
        return;
      }
      uiPassword = val;
      loginOverlay.style.display = "none";
      showToast("Console unlocked.", "neutral");
      setStatus(false, "Standby", "Ready to send commands.", "Idle", "None");
    });

    passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loginBtn.click();
    });

    setStatus(false, "Locked", "Enter PIN to begin.", "Locked", "None");
  </script>
</body>
</html>
