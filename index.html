<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Straw Dryer</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- CYBERPUNK CORE STYLES --- */
    :root { 
      --bg: #020204; 
      --panel: rgba(20, 20, 30, 0.85); 
      --primary: #00ffcc; 
      --accent: #d600ff;
      --danger: #ff2a2a; 
      --text: #e0e0ff; 
    }
    
    body { 
      margin: 0; padding: 0; 
      background-color: var(--bg);
      background-image: 
        linear-gradient(rgba(0, 255, 204, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 204, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      color: var(--text); 
      font-family: 'Rajdhani', sans-serif; 
      display: flex; flex-direction: column; align-items: center; justify-content: center; 
      min-height: 100vh; 
      overflow: hidden; 
      /* PREVENT TEXT SELECTION ON MOBILE DRAG */
      -webkit-user-select: none;
      user-select: none;
    }

    /* RAIN CONTAINER */
    #rain-container {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        pointer-events: none; z-index: 1; overflow: hidden;
    }

    /* FIRE CANVAS */
    #fire-canvas {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        pointer-events: none; z-index: 2; /* In front of straws, behind UI */
        opacity: 0;
        transition: opacity 0.5s;
    }

    .straw {
      position: absolute;
      width: 6px; height: 50px;
      border-radius: 3px;
      opacity: 0.8;
      box-shadow: 0 0 8px rgba(255,255,255,0.3);
      transform-origin: center;
    }

    /* ASH ANIMATION KEYFRAMES */
    @keyframes disintegrate {
      0% { transform: scale(1); background: #333; opacity: 1; }
      100% { transform: scale(0) rotate(20deg); background: #000; opacity: 0; }
    }

    .burning {
      /* Turn into ash/soot */
      animation: disintegrate 1s ease-out forwards !important;
      background: #222 !important; /* Ash color */
      box-shadow: none !important;
      border: 1px solid #ff4400; /* Glowing edges */
      transition: none !important;
    }

    /* MAIN PANEL */
    .container { 
      width: 90%; max-width: 450px; 
      background: var(--panel); 
      padding: 40px 30px; 
      border: 1px solid rgba(0, 255, 204, 0.3); 
      border-radius: 16px; 
      box-shadow: 0 0 80px rgba(0, 255, 204, 0.1), inset 0 0 20px rgba(0,0,0,0.8); 
      text-align: center; 
      position: relative;
      backdrop-filter: blur(10px);
      z-index: 10; 
    }

    .connection-status-group {
        position: absolute; top: 20px; right: 20px; 
        display: flex; gap: 8px; align-items: center;
        background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 20px;
        border: 1px solid #333;
    }
    .connection-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #444; transition: all 0.3s;
      box-shadow: 0 0 5px #000;
    }
    .connected { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    .dot-label { font-size: 0.8em; color: #888; font-weight: 700; letter-spacing: 1px; }

    h2 { 
      font-family: 'Orbitron', sans-serif; color: var(--primary); 
      letter-spacing: 4px; margin-bottom: 5px; text-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
      font-size: 1.8em;
    }
    .subtitle { color: var(--accent); font-size: 0.9em; letter-spacing: 2px; margin-bottom: 30px; text-transform: uppercase; }

    .fan-viz { 
      width: 160px; height: 160px; margin: 0 auto 25px; 
      border: 2px dashed rgba(255,255,255,0.2); border-radius: 50%; 
      display: flex; justify-content: center; align-items: center; 
      background: radial-gradient(circle, #222 0%, #000 100%);
      box-shadow: inset 0 0 20px #000;
    }

    .blades { 
      width: 90%; height: 90%; 
      background: conic-gradient(from 0deg, 
        var(--primary) 0deg 30deg, transparent 30deg 120deg, 
        var(--primary) 120deg 150deg, transparent 150deg 240deg, 
        var(--primary) 240deg 270deg, transparent 270deg 360deg);
      border-radius: 50%; opacity: 0.2; transition: opacity 0.5s;
      filter: drop-shadow(0 0 5px var(--primary));
    }

    .spinning { animation: spin 0.5s linear infinite; opacity: 1; filter: drop-shadow(0 0 15px var(--primary)); } 
    @keyframes spin { 100% { transform: rotate(360deg); } }

    #statusLabel { font-family: 'Orbitron', sans-serif; font-size: 1.1em; margin-bottom: 20px; min-height: 1.5em; color: #666; }

    /* FIXED SLIDER STYLES */
    input[type=range] { 
      -webkit-appearance: none; 
      width: 100%; 
      background: transparent; 
      margin: 20px 0; 
      height: 30px; /* Increased hit area for easier dragging */
      position: relative;
      z-index: 5;
      cursor: grab;
      /* PREVENT TAP HIGHLIGHT ON MOBILE */
      -webkit-tap-highlight-color: transparent;
    }
    input[type=range]:active { cursor: grabbing; }
    
    input[type=range]::-webkit-slider-thumb { 
      -webkit-appearance: none; 
      height: 20px; 
      width: 10px; 
      background: var(--primary); 
      cursor: grab; 
      margin-top: -8px; 
      box-shadow: 0 0 10px var(--primary); 
    }
    input[type=range]::-webkit-slider-runnable-track { 
      width: 100%; 
      height: 4px; 
      cursor: pointer; 
      background: #333; 
      border-radius: 2px; 
    }

    #timeReadout { font-family:'Orbitron', sans-serif; font-size: 2.5em; color: var(--text); margin-bottom: 30px; }

    .btn-group { display: flex; gap: 15px; }
    button {
      flex: 1; padding: 20px; border: none; border-radius: 4px; 
      font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 1em; 
      cursor: pointer; transition: all 0.2s; letter-spacing: 1px; text-transform: uppercase;
      /* PREVENT TAP HIGHLIGHT ON MOBILE */
      -webkit-tap-highlight-color: transparent;
    }
    .btn-start { background: rgba(0, 255, 204, 0.1); color: var(--primary); border: 1px solid var(--primary); box-shadow: 0 0 10px rgba(0, 255, 204, 0.1); }
    .btn-start:active { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
    .btn-stop { background: rgba(255, 42, 42, 0.1); color: var(--danger); border: 1px solid var(--danger); }
    .btn-stop:active { background: var(--danger); color: #000; box-shadow: 0 0 30px var(--danger); }
  </style>
</head>
<body>

  <div id="rain-container"></div>
  <canvas id="fire-canvas"></canvas>

  <div class="container">
    <div class="connection-status-group">
        <div class="connection-dot" id="workerDot"></div>
        <span class="dot-label">NET LINK</span>
    </div>

    <h2>STRAW DRYER</h2>
    <div class="subtitle">Mk-II</div>

    <div class="fan-viz"><div class="blades" id="fanBlades"></div></div>
    
    <div id="statusLabel">SYSTEM READY</div>

    <div id="timeReadout">10<span style="font-size:0.4em">MIN</span></div>
    
    <input type="range" id="slider" min="0" max="22" step="1" value="8" oninput="updateLabelFromIndex(this.value)">

    <div class="btn-group">
      <button class="btn-start" onclick="sendCommand('ON')">ACTIVATE</button>
      <button class="btn-stop" onclick="sendCommand('OFF')">ABORT</button>
    </div>
  </div>

  <script>
    // *** CONFIGURATION ***
    const WORKER_URL = "https://rapid-star-f817.fieldsnathanj.workers.dev"; 
    
    const timeSteps = [
      0.25, 0.5, 0.75, 1, 
      2, 3, 4, 5, 
      10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60,
      75, 90, 105, 120
    ];

    // *** WEB WORKER SETUP ***
    const localWorkerBlob = new Blob([`
      let timerId;
      self.onmessage = function(e) {
        if (e.data.action === 'start') {
          if (timerId) clearTimeout(timerId);
          timerId = setTimeout(() => {
            self.postMessage('finished');
          }, e.data.duration);
        } else if (e.data.action === 'stop') {
          if (timerId) clearTimeout(timerId);
        }
      };
    `], { type: 'application/javascript' });

    const timerWorker = new Worker(URL.createObjectURL(localWorkerBlob));

    timerWorker.onmessage = (e) => {
      if (e.data === 'finished') {
        console.log("Worker finished, triggering OFF command.");
        sendCommand('OFF');
      }
    };

    // *** UI ELEMENTS ***
    const blades = document.getElementById('fanBlades');
    const label = document.getElementById('statusLabel');
    const workerDot = document.getElementById('workerDot'); 
    const timeReadout = document.getElementById('timeReadout'); 
    const slider = document.getElementById('slider'); 
    const rainContainer = document.getElementById('rain-container');
    const fireCanvas = document.getElementById('fire-canvas');
    const ctx = fireCanvas.getContext('2d');

    let countdownInterval = null;
    let targetTimestamp = 0; 
    let rainInterval = null;
    const colors = ['#ff0055', '#00ffcc', '#d600ff', '#ffee00', '#0099ff'];

    // --- FIRE PARTICLE SYSTEM ---
    let fireParticles = [];
    let fireAnimationId = null;
    let isFireActive = false;

    function resizeCanvas() {
        fireCanvas.width = window.innerWidth;
        fireCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor() {
            this.x = Math.random() * fireCanvas.width;
            this.y = fireCanvas.height;
            this.size = Math.random() * 20 + 10;
            this.speedY = Math.random() * 5 + 3;
            this.speedX = (Math.random() - 0.5) * 2;
            this.color = { r: 255, g: 150, b: 0, a: 1 };
            this.decay = Math.random() * 0.02 + 0.01;
        }
        update() {
            this.y -= this.speedY;
            this.x += this.speedX;
            this.size -= 0.1;
            this.color.a -= this.decay;
            if(this.color.a > 0.8) { this.color.r = 255; this.color.g = 255; this.color.b = 200; }
            else if(this.color.a > 0.5) { this.color.r = 255; this.color.g = 140; this.color.b = 0; }
            else { this.color.r = 200; this.color.g = 50; this.color.b = 0; }
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${this.color.r},${this.color.g},${this.color.b},${this.color.a})`;
            ctx.fill();
        }
    }

    function animateFire() {
        ctx.clearRect(0, 0, fireCanvas.width, fireCanvas.height);
        if(isFireActive) {
            for(let i=0; i<15; i++) fireParticles.push(new Particle());
        }
        for (let i = 0; i < fireParticles.length; i++) {
            fireParticles[i].update();
            fireParticles[i].draw();
            if (fireParticles[i].size <= 0.2 || fireParticles[i].color.a <= 0) {
                fireParticles.splice(i, 1);
                i--;
            }
        }
        if (fireParticles.length > 0 || isFireActive) {
            fireAnimationId = requestAnimationFrame(animateFire);
        }
    }

    // --- HEALTH CHECK ---
    function pollWorkerHealth() {
        fetch(WORKER_URL + '?command=HEALTH_CHECK') 
            .then(r => r.ok ? workerDot.classList.add('connected') : workerDot.classList.remove('connected'))
            .catch(() => workerDot.classList.remove('connected'));
    }

    // --- COMMAND SENDER ---
    function sendCommand(command) {
        const durationMinutes = timeSteps[Math.round(slider.value)]; // Safely round here too
        const fetchURL = `${WORKER_URL}?command=${command}&duration=${durationMinutes}`;
        
        label.innerText = `TRANSMITTING...`;
        label.style.color = "var(--primary)";

        if (command === 'ON') {
            const durationMs = durationMinutes * 60 * 1000;
            timerWorker.postMessage({ action: 'start', duration: durationMs });
            setRunningUI(durationMinutes);
        } else if (command === 'OFF') {
            timerWorker.postMessage({ action: 'stop' });
            setStandbyUI();
        }

        fetch(fetchURL).catch(e => {
            label.innerText = "LINK FAILURE";
            label.style.color = "var(--danger)";
        });
    }

    // --- STATE MANAGERS ---
    function setRunningUI(durationMinutes) {
        blades.classList.add('spinning');
        label.innerText = "SYSTEM ACTIVE";
        label.style.color = "var(--primary)";
        startRainEffect();
        targetTimestamp = Date.now() + (durationMinutes * 60 * 1000);
        startCountdown();
    }

    function setStandbyUI() {
        blades.classList.remove('spinning');
        label.innerText = "SYSTEM STANDBY";
        label.style.color = "#666";
        triggerFireEffect(); 
        stopCountdown();
        updateLabelFromIndex(slider.value);
    }

    // --- TIMER ---
    function startCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);
        updateTimerDisplay();
        countdownInterval = setInterval(updateTimerDisplay, 1000);
    }

    function updateTimerDisplay() {
        const now = Date.now();
        const secondsRemaining = Math.ceil((targetTimestamp - now) / 1000);

        if (secondsRemaining <= 0) {
            timeReadout.innerText = "0:00";
            return;
        }

        const h = Math.floor(secondsRemaining / 3600);
        const m = Math.floor((secondsRemaining % 3600) / 60);
        const s = secondsRemaining % 60;
        
        if (h > 0) {
           timeReadout.innerText = `${h}:${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        } else {
           timeReadout.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }
    }

    function stopCountdown() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    }

    // --- ANIMATIONS & HELPERS ---
    function updateLabelFromIndex(index) {
        // FIX: Force index to be a rounded Integer. 
        // iOS drag events sometimes report floats (e.g. 1.5) which causes array lookup to fail.
        const i = Math.round(Number(index)); 
        const val = timeSteps[i];

        // Safety check: if val is undefined (glitch), do not update UI
        if (val === undefined || val === null) return; 

        if (val < 1) {
             const seconds = Math.round(val * 60);
             document.getElementById('timeReadout').innerHTML = seconds + "<span style='font-size:0.4em'>SEC</span>";
        } else if (val >= 60) {
             const hours = Math.floor(val / 60);
             const mins = val % 60;
             const display = mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
             document.getElementById('timeReadout').innerHTML = display + "<span style='font-size:0.4em'></span>";
        } else {
             document.getElementById('timeReadout').innerHTML = val + "<span style='font-size:0.4em'>MIN</span>";
        }
    }

    function startRainEffect() {
      if(rainInterval) return;
      rainInterval = setInterval(() => {
        const straw = document.createElement('div');
        straw.classList.add('straw');
        straw.style.left = Math.random() * 100 + 'vw';
        straw.style.top = '-60px';
        straw.style.background = colors[Math.floor(Math.random() * colors.length)];
        straw.style.transform = `rotate(${Math.random() * 360}deg)`;
        const duration = 1 + Math.random() * 2;
        straw.style.transition = `top ${duration}s linear`;
        rainContainer.appendChild(straw);
        setTimeout(() => { straw.style.top = (85 + Math.random() * 13) + 'vh'; }, 50);
        if(rainContainer.children.length > 300) { rainContainer.removeChild(rainContainer.firstChild); }
      }, 80); 
    }

    function triggerFireEffect() {
      if(rainInterval) { clearInterval(rainInterval); rainInterval = null; }
      isFireActive = true;
      fireCanvas.style.opacity = 1;
      animateFire();
      document.querySelectorAll('.straw').forEach((straw, index) => {
        straw.style.transition = ''; 
        setTimeout(() => { straw.classList.add('burning'); }, index * 2);
      });
      setTimeout(() => { 
          isFireActive = false; 
          fireCanvas.style.opacity = 0; 
          rainContainer.innerHTML = ''; 
      }, 1750);
    }

    // --- INIT ---
    updateLabelFromIndex(slider.value);
    setInterval(pollWorkerHealth, 5000);   
    pollWorkerHealth(); 
  </script>
</body>
</html>
